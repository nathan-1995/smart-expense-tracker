files:
  "/usr/local/bin/fintrack_configure_ssl.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -euo pipefail

      NGINX_CONF_DIR="/etc/nginx/conf.d"
      mkdir -p "$NGINX_CONF_DIR"

      write_conf() {
        local target_path="$1"
        local content="$2"
        local tmp
        tmp="$(mktemp)"
        printf "%s\n" "$content" > "$tmp"
        install -m 0644 "$tmp" "$target_path"
        rm -f "$tmp"
      }

      remove_if_exists() {
        local path="$1"
        if [ -f "$path" ]; then
          rm -f "$path"
        fi
      }

      DEV_DOMAIN="api-dev.fintracker.cc"
      DEV_CERT_DIR="/etc/letsencrypt/live/${DEV_DOMAIN}"
      DEV_CONF="${NGINX_CONF_DIR}/https.conf"

      PROD_DOMAIN="api.fintracker.cc"
      PROD_CERT_DIR="/etc/letsencrypt/live/${PROD_DOMAIN}"
      PROD_CONF="${NGINX_CONF_DIR}/https-prod.conf"

      if [ -d "$DEV_CERT_DIR" ]; then
        write_conf "$DEV_CONF" "$(cat <<'EOF'
      # HTTPS server block
      server {
          listen 443 ssl;
          server_name api-dev.fintracker.cc;

          ssl_certificate /etc/letsencrypt/live/api-dev.fintracker.cc/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/api-dev.fintracker.cc/privkey.pem;
          include /etc/letsencrypt/options-ssl-nginx.conf;
          ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

          gzip on;
          gzip_comp_level 4;
          gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

          access_log /var/log/nginx/access.log;

          location / {
              proxy_pass http://docker;
              proxy_http_version 1.1;

              proxy_set_header Connection $connection_upgrade;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          include conf.d/elasticbeanstalk/*.conf;
      }

      # HTTP to HTTPS redirect
      server {
          listen 80;
          server_name api-dev.fintracker.cc;
          return 301 https://$host$request_uri;
      }
      EOF
      )"
      else
        remove_if_exists "$DEV_CONF"
      fi

      if [ -d "$PROD_CERT_DIR" ]; then
        write_conf "$PROD_CONF" "$(cat <<'EOF'
      # HTTPS server block for production
      server {
          listen 443 ssl;
          server_name api.fintracker.cc;

          ssl_certificate /etc/letsencrypt/live/api.fintracker.cc/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/api.fintracker.cc/privkey.pem;
          include /etc/letsencrypt/options-ssl-nginx.conf;
          ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

          gzip on;
          gzip_comp_level 4;
          gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

          access_log /var/log/nginx/access.log;

          location / {
              proxy_pass http://docker;
              proxy_http_version 1.1;

              proxy_set_header Connection $connection_upgrade;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          include conf.d/elasticbeanstalk/*.conf;
      }

      # HTTP to HTTPS redirect for production
      server {
          listen 80;
          server_name api.fintracker.cc;
          return 301 https://$host$request_uri;
      }
      EOF
      )"
      else
        remove_if_exists "$PROD_CONF"
      fi

  "/etc/systemd/system/nginx.service.d/10-fintrack-ssl.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Service]
      # Ensure nginx restarts are always clean (EB deploy + EB config updates)
      ExecStartPre=
      # If systemd lost track of nginx (stale/empty PID file), ensure no orphan workers keep port 80/443 busy
      ExecStartPre=-/usr/bin/pkill -TERM nginx
      ExecStartPre=/usr/bin/sleep 1
      ExecStartPre=-/usr/bin/pkill -KILL nginx
      # Ensure stale PID files never break nginx restarts
      ExecStartPre=/usr/bin/rm -f /run/nginx.pid /var/run/nginx.pid
      # Re-create SSL vhosts on every nginx restart (app deploy + config deploy)
      ExecStartPre=/usr/local/bin/fintrack_configure_ssl.sh
      ExecStartPre=/usr/sbin/nginx -t

commands:
  00_reload_systemd:
    command: systemctl daemon-reload
    ignoreErrors: false
